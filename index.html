<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fundiæŠ½é¸ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="styles/style.css">
</head>

<body>
    <header>
        <h1>ğŸ¯ fundiæŠ½é¸ã‚¢ãƒ—ãƒª</h1>
    </header>
    <main>
        <section id="æŠ½é¸">
            <h2>æŠ½é¸è¨­å®š</h2>
            <form id="lottery-form">
                <label for="csv-file">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</label>
                <input type="file" id="csv-file" accept=".csv" required>
                <br><br>
                <label for="budget">æŠ½é¸äºˆç®—é‡‘é¡:</label>
                <input type="number" id="budget" name="budget" min="1" required>
                <br><br>
                <label for="exclude">é™¤å¤–ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):</label>
                <input type="text" id="exclude" name="exclude"
                    placeholder="ä¾‹: sample1@example.com, sample2@example.com">
                <br><br>
                <button type="button" onclick="submitForm()">æŠ½é¸é–‹å§‹</button>
            </form>
            <div id="result">
                <!-- æŠ½é¸çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 fundi All Rights Reserved.</p>
    </footer>

    <script>
        console.log("2024/12/05 v2");

        function submitForm() {
            const fileInput = document.getElementById("csv-file");
            const budget = parseInt(document.getElementById("budget").value, 10);
            const excludeInput = document.getElementById("exclude").value;
            const resultDiv = document.getElementById("result");

            if (!fileInput.files[0]) {
                alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const excludeList = excludeInput.split(",").map(email => email.trim()).filter(email => email);

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const csvData = event.target.result;
                    // ç©ºè¡Œã‚’é™¤å»ã—ã€å„è¡Œã‚’ãƒˆãƒªãƒ 
                    const rows = csvData.split("\n")
                        .map(row => row.trim())
                        .filter(row => row.length > 0)
                        .map(row => row.split(",").map(cell => cell.trim()));

                    const header = rows[0];

                    const emailIndex = header.findIndex(col =>
                        col.includes("ãƒ¡ãƒ¼ãƒ«") || col.toLowerCase().includes("mail"));
                    const amountIndex = header.findIndex(col =>
                        col.includes("é‡‘é¡") || col.includes("é¡") || col.toLowerCase().includes("amount"));

                    if (emailIndex === -1 || amountIndex === -1) {
                        resultDiv.innerHTML = `
                            <p class="error">CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                            <p>ä»¥ä¸‹ã®åˆ—ãŒå¿…è¦ã§ã™ï¼š</p>
                            <ul>
                                <li>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (ã¾ãŸã¯ "mail"ã‚’å«ã‚€åˆ—å)</li>
                                <li>é‡‘é¡ (ã¾ãŸã¯ "amount"ã‚’å«ã‚€åˆ—å)</li>
                            </ul>
                            <p>ç¾åœ¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼: ${header.join(", ")}</p>
                        `;
                        return;
                    }

                    const data = rows.slice(1).filter(row => row.length >= Math.max(emailIndex, amountIndex) + 1);

                    if (data.length === 0) {
                        resultDiv.innerHTML = "<p class='error'>æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
                        return;
                    }

                    const validData = data
                        .filter(row => {
                            const email = row[emailIndex];
                            const amount = parseInt(row[amountIndex], 10);
                            return (
                                email &&
                                !excludeList.includes(email) &&
                                !isNaN(amount) &&
                                amount > 0
                            );
                        })
                        .map(row => ({
                            email: row[emailIndex],
                            amount: parseInt(row[amountIndex], 10)
                        }));

                    // ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆ
                    const shuffled = validData.sort(() => Math.random() - 0.5);

                    let remainingBudget = budget;
                    const selected = [];
                    let partialWin = null;

                    // å®Œå…¨å½“é¸è€…ã®é¸å®š
                    for (let i = 0; i < shuffled.length - 1; i++) {
                        const item = shuffled[i];
                        if (item.amount <= remainingBudget) {
                            selected.push(item);
                            remainingBudget -= item.amount;
                        }
                    }

                    // æœ€å¾Œã®1äººã®éƒ¨åˆ†å½“é¸å‡¦ç†
                    const lastPerson = shuffled[shuffled.length - 1];
                    if (remainingBudget > 0 && lastPerson) {
                        const partialAmount = Math.min(lastPerson.amount, remainingBudget);
                        partialWin = {
                            email: lastPerson.email,
                            requestedAmount: lastPerson.amount,
                            awardedAmount: partialAmount
                        };
                        remainingBudget -= partialAmount;
                    }

                    // çµæœã‚’è¡¨ç¤º
                    let resultHtml = `
                        <h3>æŠ½é¸çµæœ</h3>
                        <p>å®Œå…¨å½“é¸è€…æ•°: ${selected.length}å</p>
                        <h4>å®Œå…¨å½“é¸è€…ä¸€è¦§:</h4>
                        <ul>
                    `;
                    selected.forEach(item => {
                        resultHtml += `<li>${item.email} - ${item.amount.toLocaleString()}å††</li>`;
                    });
                    resultHtml += "</ul>";

                    if (partialWin) {
                        resultHtml += `
                            <h4>éƒ¨åˆ†å½“é¸è€…:</h4>
                            <p>${partialWin.email} - ${partialWin.awardedAmount.toLocaleString()}å†† 
                            (ç”³è«‹é¡: ${partialWin.requestedAmount.toLocaleString()}å††)</p>
                        `;
                    }

                    resultHtml += `
                        <h4>äºˆç®—çŠ¶æ³:</h4>
                        <p>ç·äºˆç®—: ${budget.toLocaleString()}å††</p>
                        <p>ä½¿ç”¨é‡‘é¡: ${(budget - remainingBudget).toLocaleString()}å††</p>
                        <p>æ®‹é¡: ${remainingBudget.toLocaleString()}å††</p>
                    `;

                    resultDiv.innerHTML = resultHtml;

                } catch (error) {
                    console.error("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                    resultDiv.innerHTML = `
                        <p class="error">ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                        <p>ã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}</p>
                    `;
                }
            };

            reader.onerror = function (error) {
                console.error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                resultDiv.innerHTML = "<p class='error'>ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>";
            };

            reader.readAsText(fileInput.files[0]);
        }
    </script>
</body>

</html>