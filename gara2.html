<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FUNDI</title>
  <meta name="keywords" content="">
  <meta name="description" content="FUNDI">

  <meta property="og:type" content="website">
  <meta property="og:title" content="FUNDI">
  <meta property="og:description" content="FUNDI">
  <meta property="og:url" content="https://">
  <meta property="og:site_name" content="FUNDI">

  <meta property="og:image" content="" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto+Serif:ital,opsz,wght@0,8..144,100..900;1,8..144,100..900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/common.css">
  <link rel="stylesheet" href="./css/swiper.css">
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/extra.css">
  <link rel="stylesheet" href="./css/add.css">
  <link rel="stylesheet" href="./css/gara.css">
</head>

<body class="pChild">
  <div id="container" class="container">
    <main>
      <div class="pChild__gara reward">
        <div class="reward__main">
          <div class="reward__main--top">
            <div class="left">
              <figure><img src="./img/garaImg2.png" alt=""></figure>
            </div>
            <div class="right">
              <figure>
                <img src="./img/garaImg.png" alt="">
              </figure>
            </div>
          </div>
          <div class="reward__main--list">
            <table>
              <thead>
                <tr>
                  <th>メールアドレス</th>
                  <th>口数</th>
                  <th>金額</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
                <tr>
                  <td>examplexxxxx@xxxxx.com</td>
                  <td>10</td>
                  <td>¥500,000</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script src="./js/libs.js"></script>
  <script src="./js/gara.js"></script>
  <!-- <script src="./js/script.js"></script> -->

  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const winners = JSON.parse(localStorage.getItem('lotteryResults')) || [];
        const tbody = document.querySelector('.reward__main--list tbody');
        const downloadTrigger = document.querySelector('.left figure img'); // クリックトリガー要素

        tbody.innerHTML = '';

        let totalAmount = 0;
        let totalLotCount = 0;

        const csvData = [];
        csvData.push(['お客様番号', 'メールアドレス', '口数', '金額', '部分当選']); // CSVヘッダー

        winners.forEach(winner => {
          const tr = document.createElement('tr');
          const formattedAmount = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(winner.amount);
          const isPartialWin = winner.isPartialWin ? '⚪︎' : '';

          tr.innerHTML = `
        <td>${winner.email}</td>
        <td>${winner.lotCount}</td> 
        <td>${formattedAmount}</td>
      `;

          tbody.appendChild(tr);

          // CSVデータに追加
          csvData.push([winner.customerNumber || '—', winner.email, winner.lotCount, winner.amount, isPartialWin]);

          totalAmount += winner.amount;
          totalLotCount += winner.lotCount;
        });

        // デバッグ情報の出力
        console.log('合計金額:', new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(totalAmount));
        console.log('合計口数:', totalLotCount);

        downloadTrigger.addEventListener('click', function () {
          const csvContent = csvData.map(row => row.join(',')).join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);

          // 現在の日時を取得して、ファイル名に含める
          const now = new Date();
          const formattedDate = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
          const fileName = `winners_${formattedDate}.csv`;

          const downloadLink = document.createElement('a');
          downloadLink.href = url;
          downloadLink.setAttribute('download', fileName); // 日時付きのファイル名
          downloadLink.style.display = 'none';  // リンクを非表示に
          document.body.appendChild(downloadLink);

          // 自動でダウンロードを開始
          downloadLink.click();

          // クリーンアップ
          setTimeout(() => {
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
          }, 100);
        });
      });
  </script>
</body>

</html>